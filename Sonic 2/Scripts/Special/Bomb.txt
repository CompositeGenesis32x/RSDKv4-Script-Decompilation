// ----------------------------------
// RSDK Project: Sonic 2
// Script Description: Bomb Object
// Script Author: Christian Whitehead/Simon Thomley
// Unpacked by Rubberduckycooly's script unpacker
// ----------------------------------

// ========================
// Aliases
// ========================
private alias object.value1  : object.stagePos.x
private alias object.value2  : object.stagePos.y
private alias object.value3  : object.stagePos.z
private alias object.value4  : object.spriteVertex.x
private alias object.value5  : object.spriteVertex.y
private alias object.value6  : object.spriteVertex.z

private alias object.value7  : object.shadowsEnabled
private alias object.value8  : object.shadowPos.x
private alias object.value9  : object.shadowPos.y
private alias object.value11 : object.shadowVertex.x
private alias object.value12 : object.shadowVertex.y
private alias object.value13 : object.shadowVertex.z
private alias object.value14 : object.shadowVertex.u

// Halfpipe Aliases
private alias object.value13 : halfpipe.playerPos.z

// Player Aliases
private alias object.state : player.state
private alias object.gravity : player.gravity

private alias object.value7  : player.invincibilityTimer
private alias object.value14 : player.stagePos.z
private alias object.value15 : player.stagePos.x
private alias object.value16 : player.stagePos.y

event ObjectUpdate
	arrayPos0 = scene3D.vertexCount
	arrayPos1 = scene3D.faceCount
	if object.shadowsEnabled == true
		faceBuffer[arrayPos1].flag = 6
		faceBuffer[arrayPos1].a = arrayPos0
		vertexBuffer[arrayPos0].x = object.shadowVertex.x
		vertexBuffer[arrayPos0].y = object.shadowVertex.y
		vertexBuffer[arrayPos0].z = object.shadowVertex.z
		vertexBuffer[arrayPos0].u = object.shadowVertex.u
		vertexBuffer[arrayPos0].v = 50
		arrayPos0++

		faceBuffer[arrayPos1].b = arrayPos0
		vertexBuffer[arrayPos0].x = object.shadowVertex.x
		vertexBuffer[arrayPos0].y = object.shadowVertex.y
		vertexBuffer[arrayPos0].z = object.shadowVertex.z
		temp0 = object[0].ypos
		temp0 -= 0xE00000
		object.scale = object.ypos
		object.scale -= temp0
		if object.scale > 0
			object.scale >>= 14
			object.scale += 0x400
		else
			object.scale = 0x400
		end if
		vertexBuffer[arrayPos0].u = object.scale
		vertexBuffer[arrayPos0].v = object.scale
		arrayPos0++

		faceBuffer[arrayPos1].c = arrayPos0
		vertexBuffer[arrayPos0].x = object.shadowVertex.x
		vertexBuffer[arrayPos0].y = object.shadowVertex.y
		vertexBuffer[arrayPos0].z = object.shadowVertex.z
		vertexBuffer[arrayPos0].u = 17
		vertexBuffer[arrayPos0].v = 16
		arrayPos0++

		faceBuffer[arrayPos1].d = arrayPos0
		vertexBuffer[arrayPos0].x = object.shadowVertex.x
		vertexBuffer[arrayPos0].y = object.shadowVertex.y
		vertexBuffer[arrayPos0].z = object.shadowVertex.z
		arrayPos0++

		arrayPos1++
		scene3D.vertexCount += 4
		scene3D.faceCount++
	end if
	
	faceBuffer[arrayPos1].flag = 5
	faceBuffer[arrayPos1].a = arrayPos0
	vertexBuffer[arrayPos0].x = object.spriteVertex.x
	vertexBuffer[arrayPos0].y = object.spriteVertex.y
	vertexBuffer[arrayPos0].z = object.spriteVertex.z
	vertexBuffer[arrayPos0].u = 83
	vertexBuffer[arrayPos0].v = 50
	arrayPos0++

	faceBuffer[arrayPos1].b = arrayPos0
	vertexBuffer[arrayPos0].x = object.spriteVertex.x
	vertexBuffer[arrayPos0].y = object.spriteVertex.y
	vertexBuffer[arrayPos0].z = object.spriteVertex.z
	temp0 = object[0].ypos
	temp0 -= 0x1000000
	temp1 = object.ypos
	temp1 -= temp0
	if temp1 > 0
		temp1 >>= 14
		temp1 += 0x600
	else
		temp1 = 0x600
	end if
	vertexBuffer[arrayPos0].u = temp1
	vertexBuffer[arrayPos0].v = temp1
	arrayPos0++

	faceBuffer[arrayPos1].c = arrayPos0
	vertexBuffer[arrayPos0].x = object.spriteVertex.x
	vertexBuffer[arrayPos0].y = object.spriteVertex.y
	vertexBuffer[arrayPos0].z = object.spriteVertex.z
	vertexBuffer[arrayPos0].u = 16
	vertexBuffer[arrayPos0].v = 16
	arrayPos0++

	faceBuffer[arrayPos1].d = arrayPos0
	vertexBuffer[arrayPos0].x = object.spriteVertex.x
	vertexBuffer[arrayPos0].y = object.spriteVertex.y
	vertexBuffer[arrayPos0].z = object.spriteVertex.z
	scene3D.vertexCount += 4
	scene3D.faceCount++

	if object.stagePos.z < halfpipe[0].playerPos.z
		object.type = TypeName[Blank Object]
	else
		foreach (TypeName[Player Object], currentPlayer, ACTIVE_ENTITIES)
			temp1 = object.stagePos.z
			temp1 -= 0x20000
			temp2 = object.stagePos.z
			temp2 += 0x20000
			if player[currentPlayer].stagePos.z > temp1
				if player[currentPlayer].stagePos.z < temp2
					temp0 = player[currentPlayer].stagePos.x
					temp0 -= object.stagePos.x
					temp1 = temp0
					temp1 *= temp0
					
					temp0 = player[currentPlayer].stagePos.y
					temp0 -= object.stagePos.y
					temp2 = temp0
					temp2 *= temp0
					temp1 += temp2

					if temp1 < 0xC40000
						object.type = TypeName[Explosion]
						object.animationTimer = 0
						object.frame = 0

						if player[currentPlayer].state != Player_State_Hurt
							if player[currentPlayer].invincibilityTimer == 0
								CallFunction(Player_LoseRings)
								if player[currentPlayer].gravity == 0
									player[currentPlayer].state = Player_State_Hurt
								else
									player[currentPlayer].invincibilityTimer = 60
								end if
							end if
						end if
						PlaySfx(SfxName[Bomb], false)
					end if
				end if
			end if
		next
	end if
end event


event ObjectStartup
	LoadSpriteSheet("Special/Objects.gif")
	foreach (TypeName[Bomb], arrayPos0, ALL_ENTITIES)
		object[arrayPos0].angle = object[arrayPos0].ixpos
		object[arrayPos0].angle -= 448
		object[arrayPos0].angle &= 0x1FF

		Sin(object[arrayPos0].stagePos.x, object[arrayPos0].angle)
		object[arrayPos0].stagePos.x *= -48
		object[arrayPos0].stagePos.x >>= 1

		Cos(object[arrayPos0].stagePos.y, object[arrayPos0].angle)
		object[arrayPos0].stagePos.y *= -48
		object[arrayPos0].stagePos.y >>= 1

		if object[arrayPos0].stagePos.y < -0x800
			object[arrayPos0].shadowsEnabled = true

			Sin(object[arrayPos0].shadowPos.x, object[arrayPos0].angle)
			object[arrayPos0].shadowPos.x *= -60
			object[arrayPos0].shadowPos.x >>= 1

			Cos(object[arrayPos0].shadowPos.y, object[arrayPos0].angle)
			object[arrayPos0].shadowPos.y *= -60
			object[arrayPos0].shadowPos.y >>= 1

			object[arrayPos0].shadowVertex.u = 116
			if object[arrayPos0].angle > 32
				if object[arrayPos0].angle < 480
					if object[arrayPos0].angle < 256
						object[arrayPos0].shadowVertex.u = 149
					else
						object[arrayPos0].shadowVertex.u = 182
					end if
				end if
			end if
		end if
	next
end event


event RSDKDraw
	DrawSprite(0)
end event


event RSDKLoad
	LoadSpriteSheet("Special/Objects.gif")
	SpriteFrame(-8, -8, 16, 16, 233, 17)
	
	SetVariableAlias(ALIAS_VAR_PROPVAL, "unused")
end event
