// ----------------------------------
// RSDK Project: Sonic 1
// Script Description: SYZ Setup Object
// Script Author: Christian Whitehead/Simon Thomley
// Unpacked by Rubberduckycooly's script unpacker
// ----------------------------------

// Aliases
private alias object.value0 : object.palRotateTimer
private alias object.value1 : object.palRotateIndex
private alias object.value2 : object.rLightTimer

// Function declarations
reserve function SYZSetup_SpeedUpMusic
reserve function SYZSetup_SlowDownMusic

// Static Values
public value SYZSetup_value29 = 0;
public value SYZSetup_value30 = 0;

private alias SYZSetup_value29 : SYZSetup_oscillation
private alias SYZSetup_value30 : SYZSetup_RLightFrame

// Tracks
private alias 0 : TRACK_STAGE
private alias 2 : TRACK_INVINCIBLE

// Reserved object slots
private alias 10 : SLOT_ZONESETUP
private alias 25 : SLOT_MUSICEVENT_CHANGE
private alias 26 : SLOT_MUSICEVENT_BOSS

// Music Events
private alias 0 : MUSICEVENT_FADETOBOSS
private alias 1 : MUSICEVENT_FADETOSTAGE
private alias 2 : MUSICEVENT_TRANSITION

private alias 0 : MUSICEVENT_FLAG_NOCHANGE
private alias 1 : MUSICEVENT_FLAG_SPEEDUP
private alias 2 : MUSICEVENT_FLAG_SLOWDOWN

// Tables

private table SYZSetup_replay_attract_S
	0x300000, 0x3BD0000
	0b00000000, 100
	0b00001000, 33
	0b00111000, 1
	0b00101000, 19
	0b00000000, 22
	0b00000100, 18
	0b00110000, 1
	0b00100000, 2
	0b00101000, 39
	0b00000000, 10
	0b00001000, 7
	0b00000000, 13
	0b00001000, 11
	0b00000000, 17
	0b00001000, 14
	0b00000000, 20
	0b00000100, 15
	0b00000000, 30
	0b00111000, 1
	0b00101000, 11
	0b00100000, 29
	0b00101000, 8
	0b00100000, 39
	0b00000000, 7
	0b00000100, 27
	0b00000110, 2
	0b00000010, 32
	0b00000000, 14
	0b00000100, 45
	0b00000000, 37
	0b00001000, 8
	0b00000000, 20
	0b00110000, 1
	0b00100100, 7
	0b00000100, 49
	0b00110100, 1
	0b00100100, 18
	0b00000100, 28
	0b00000000, 20
	0b00001000, 9
	0b00000000, 19
	0b00000010, 9
	0b00110010, 1
	0b00100010, 5
	0b00000010, 7
	0b00110010, 1
	0b00100010, 4
	0b00000010, 5
	0b00110010, 1
	0b00100010, 4
	0b00000010, 33
	0b00000000, 73
	0b00001000, 69
	0b00000000, 16
	0b00000100, 45
	0b00000000, 62
	0b00001000, 19
	0b00000000, 4
	0b00000100, 39
	0b00000000, 36
	0b00000100, 9
	0b00000000, 16
	0b00001000, 7
	0b00000000, 7
	0b00000010, 17
	0b00000000, 23
	0b00001000, 18
	0b00111000, 1
	0b00101000, 41
	0b00001000, 16
	0b00000000, 32
	0b00000010, 14
	0b00000000, 2
	0b00001000, 25
	0b00000000, 11
	0b00000100, 9
	0b00000000, 44
	0b00001000, 5
	0b00000000, 14
	0b00001000, 45
	0b00000000, 52
	0b00000100, 38
	0b00110100, 1
	0b00100100, 5
	0b00000000, 13
	0b00001000, 7
	0b00000000, 21
	0b00001000, 8
end table

private table SYZSetup_replay_attract_T
	0x300000, 0x3C10000
	0b00000000, 76
	0b00001000, 27
	0b00111000, 1
	0b00101000, 24
	0b00001000, 4
	0b00000000, 15
	0b00000100, 16
	0b00110100, 1
	0b00100100, 4
	0b00100000, 5
	0b00101000, 30
	0b00001000, 8
	0b00000000, 9
	0b00001000, 13
	0b00000000, 12
	0b00001000, 14
	0b00000000, 15
	0b00001000, 13
	0b00000000, 15
	0b00000100, 16
	0b00000000, 13
	0b00001000, 11
	0b00111000, 1
	0b00101000, 21
	0b00100000, 13
	0b00100100, 21
	0b00000100, 38
	0b00000010, 18
	0b00000000, 31
	0b00000100, 51
	0b00000000, 9
	0b00001000, 23
	0b00000000, 8
	0b00110100, 1
	0b00100100, 30
	0b00000100, 29
	0b00110100, 1
	0b00100100, 26
	0b00000100, 29
	0b00000000, 9
	0b00001000, 13
	0b00000000, 14
	0b00000010, 13
	0b00110010, 1
	0b00100010, 7
	0b00000010, 9
	0b00000000, 69
	0b00001000, 39
	0b00111000, 1
	0b00101000, 9
	0b00001000, 28
	0b00000000, 15
	0b00000100, 54
	0b00000000, 72
	0b00000100, 7
	0b00110000, 1
	0b00100000, 13
	0b00000000, 6
	0b00110000, 1
	0b00100000, 7
	0b00000000, 4
	0b00110000, 1
	0b00100000, 5
	0b00000000, 6
	0b00111000, 1
	0b00101000, 3
	0b00001000, 9
	0b00111000, 1
	0b00101000, 5
	0b00001000, 4
	0b00000000, 2
	0b00110000, 1
	0b00100000, 5
	0b00000000, 5
	0b00110100, 1
	0b00100100, 6
	0b00100000, 2
	0b00000000, 5
	0b00110000, 1
	0b00100000, 6
	0b00000000, 6
	0b00110000, 1
	0b00100000, 3
	0b00100100, 3
	0b00000100, 5
	0b00110000, 1
	0b00100000, 7
	0b00000000, 3
	0b00000100, 5
	0b00110000, 1
	0b00100000, 7
	0b00000000, 6
	0b00110000, 1
	0b00100000, 5
	0b00000000, 4
	0b00001000, 2
	0b00111000, 1
	0b00101000, 3
	0b00100000, 2
	0b00000000, 6
	0b00110000, 1
	0b00100000, 5
	0b00000000, 7
	0b00110000, 1
	0b00100000, 5
	0b00000000, 2
	0b00001000, 8
	0b00111000, 1
	0b00101000, 5
	0b00001000, 5
	0b00000000, 7
	0b00000100, 39
	0b00110100, 1
	0b00100100, 5
	0b00101000, 3
	0b00001000, 3
	0b00111000, 1
	0b00101000, 8
	0b00001000, 26
	0b00110000, 1
	0b00100000, 4
	0b00100100, 4
	0b00000100, 3
	0b00000000, 12
	0b00001000, 56
	0b00000000, 14
	0b00000100, 37
	0b00000000, 3
	0b00110100, 1
	0b00100100, 12
	0b00000100, 14
	0b00000000, 11
	0b00001000, 15
	0b00111000, 1
	0b00101000, 15
	0b00001000, 6
	0b00000000, 21
	0b00000100, 54
	0b00000000, 21
	0b00001000, 63
	0b00111000, 1
	0b00101000, 2
	0b00100000, 17
	0b00000000, 39
end table

private table SYZSetup_replay_attract_K
	0x300000, 0x3BD0000
	0b00000000, 25
	0b00001000, 47
	0b00111000, 1
	0b00101000, 7
	0b00000000, 27
	0b00000100, 9
	0b00000000, 2
	0b00000100, 5
	0b00110100, 1
	0b00100100, 5
	0b00101000, 32
	0b00001000, 6
	0b00000000, 30
	0b00000100, 14
	0b00000000, 4
	0b00001000, 7
	0b00000000, 18
	0b00000010, 12
	0b00110010, 1
	0b00100010, 4
	0b00000000, 21
	0b00001000, 10
	0b00111000, 1
	0b00101000, 23
	0b00001000, 5
	0b00111000, 1
	0b00101000, 28
	0b00001000, 1
	0b00000000, 16
	0b00000100, 89
	0b00000000, 8
	0b00001000, 154
	0b00111000, 1
	0b00101000, 6
	0b00001000, 55
	0b00000000, 11
	0b00000100, 18
	0b00000000, 122
	0b00001000, 41
	0b00000000, 9
	0b00001000, 13
	0b00000000, 11
	0b00000100, 6
	0b00000000, 10
	0b00000100, 11
	0b00000000, 3
	0b00000010, 46
	0b00000000, 14
	0b00001000, 27
	0b00000000, 20
	0b00000100, 44
	0b00110100, 1
	0b00100100, 26
	0b00000100, 46
	0b00110100, 1
	0b00100100, 6
	0b00000000, 5
	0b00001000, 17
	0b00000000, 25
	0b00000100, 47
	0b00000000, 11
	0b00000010, 16
	0b00000000, 19
	0b00000100, 27
	0b00000000, 30
	0b00000010, 57
	0b00000000, 58
	0b00000010, 11
	0b00000000, 27
	0b00001000, 14
	0b00000000, 35
	0b00110000, 1
	0b00100000, 17
	0b00000000, 8
	0b00001000, 5
	0b00111000, 1
	0b00101000, 40
	0b00001000, 6
	0b00000000, 5
	0b00110000, 1
	0b00100000, 6
	0b00000000, 12
	0b00001000, 4
	0b00000000, 42
	0b00001000, 11
	0b00111000, 1
	0b00101000, 9
	0b00001000, 40
	0b00111000, 1
	0b00101000, 4
end table

private table SYZSetup_replay_credits_STK
	0x17500000, 0xBD0000
	0b00000000, 31
	0b00001000, 36
	0b00000000, 12
	0b00001000, 38
	0b00000000, 4
	0b00000010, 221
	0b00000000, 68
	0b00000010, 91
	0b00000000, 40
	0b00110000, 1
	0b00100000, 96
	0b00000000, 3
	0b00000010, 13
end table

function SYZSetup_SpeedUpMusic
	CheckEqual(object[SLOT_MUSICEVENT_CHANGE].type, TypeName[Music Event])
	temp0 = checkResult
	CheckEqual(object[SLOT_MUSICEVENT_CHANGE].propertyValue, 2)
	temp0 &= checkResult
	CheckEqual(stage.musicFlag, MUSICEVENT_FLAG_NOCHANGE)
	temp0 &= checkResult
	if temp0 == false
		switch music.currentTrack
		case TRACK_STAGE
			SetMusicTrack("Invincibility_F.ogg", TRACK_INVINCIBLE, 30436)
			SwapMusicTrack("SpringYard_F.ogg", TRACK_STAGE, 81128, 8000)
			break

		case TRACK_INVINCIBLE
			SetMusicTrack("SpringYard_F.ogg", TRACK_STAGE, 81128)
			SwapMusicTrack("Invincibility_F.ogg", TRACK_INVINCIBLE, 30436, 8000)
			break

		case TRACK_BOSS
			SetMusicTrack("SpringYard_F.ogg", TRACK_STAGE, 81128)
			SetMusicTrack("Invincibility_F.ogg", TRACK_INVINCIBLE, 30436)
			break

		end switch
	else
		stage.musicFlag = MUSICEVENT_FLAG_SPEEDUP
	end if
end function


function SYZSetup_SlowDownMusic
	CheckEqual(object[SLOT_MUSICEVENT_CHANGE].type, TypeName[Music Event])
	temp0 = checkResult
	CheckEqual(object[SLOT_MUSICEVENT_CHANGE].propertyValue, 2)
	temp0 &= checkResult
	CheckEqual(stage.musicFlag, MUSICEVENT_FLAG_NOCHANGE)
	temp0 &= checkResult
	if temp0 == false
		switch music.currentTrack
		case TRACK_STAGE
			SetMusicTrack("Invincibility.ogg", TRACK_INVINCIBLE, 39528)
			SwapMusicTrack("SpringYard.ogg", TRACK_STAGE, 101364, 12500)
			break

		case TRACK_INVINCIBLE
			SetMusicTrack("SpringYard.ogg", TRACK_STAGE, 101364)
			SwapMusicTrack("Invincibility.ogg", TRACK_INVINCIBLE, 39528, 12500)
			break

		case TRACK_BOSS
			SetMusicTrack("SpringYard.ogg", TRACK_STAGE, 101364)
			SetMusicTrack("Invincibility.ogg", TRACK_INVINCIBLE, 39528)
			break

		end switch
	else
		stage.musicFlag = MUSICEVENT_FLAG_SLOWDOWN
	end if
end function


event ObjectMain
	object.palRotateTimer++
	if object.palRotateTimer == 6
		object.palRotateTimer = 0
		object.palRotateIndex++
		object.palRotateIndex &= 3
		temp0 = object.palRotateIndex
		temp0++
		CopyPalette(temp0, 160, 0, 160, 32)
	end if

	object.rLightTimer++
	object.rLightTimer %= 48
	SYZSetup_RLightFrame = object.rLightTimer
	SYZSetup_RLightFrame >>= 3

	SYZSetup_oscillation++
	SYZSetup_oscillation %= 356
end event


event ObjectStartup
	// Set the music track
	SetMusicTrack("SpringYard.ogg", TRACK_STAGE, 101364)

	// Also set the speed up/slow down functions
	SpeedUpMusic = SYZSetup_SpeedUpMusic
	SlowDownMusic = SYZSetup_SlowDownMusic

	// Load colors used for the palette cycle
	temp0 = 1
	temp1 = 0
	temp2 = 32
	while temp0 < 5
		LoadPalette("SYZ_PalCycle.act", temp0, 160, temp1, temp2)
		temp0++
		temp1 += 32
		temp2 += 32
	loop

	// Set the animal types
	animalType1 = TypeName[Cucky]
	animalType2 = TypeName[Picky]

	// Set object 10 to an SYZ Setup object
	object[SLOT_ZONESETUP].type = TypeName[SYZ Setup]
	object[SLOT_ZONESETUP].priority = PRIORITY_ACTIVE

	SYZSetup_oscillation = 0
	SYZSetup_RLightFrame = 0f

	if options.attractMode == true
		switch stage.playerListPos
		case PlayerName[SONIC]
			if credits.screen == 0
				PlayerObject_ReplayTable = SYZSetup_replay_attract_S
				PlayerObject_ReplaySize = 178
				PlayerObject_ReplayLength = 0x708
			else
				PlayerObject_ReplayTable = SYZSetup_replay_credits_STK
				PlayerObject_ReplaySize = 28
				PlayerObject_ReplayLength = 540
			end if
			break

		case PlayerName[TAILS]
			if credits.screen == 0
				PlayerObject_ReplayTable = SYZSetup_replay_attract_T
				PlayerObject_ReplaySize = 290
				PlayerObject_ReplayLength = 1800
			else
				PlayerObject_ReplayTable = SYZSetup_replay_credits_STK
				PlayerObject_ReplaySize = 28
				PlayerObject_ReplayLength = 540
			end if
			break

		case PlayerName[KNUCKLES]
			if credits.screen == 0
				PlayerObject_ReplayTable = SYZSetup_replay_attract_K
				PlayerObject_ReplaySize = 182
				PlayerObject_ReplayLength = 1800
			else
				PlayerObject_ReplayTable = SYZSetup_replay_credits_STK
				PlayerObject_ReplaySize = 28
				PlayerObject_ReplayLength = 540
			end if
			break
		end switch

		CallFunction(PlayerObject_InitReplay)
	end if
end event


event RSDKDraw
	DrawSprite(0)
end event


event RSDKLoad
	LoadSpriteSheet("Global/Display.gif")
	SpriteFrame(-16, -16, 32, 32, 1, 143)
	
	SetVariableAlias(ALIAS_VAR_PROPVAL, "unused")
end event
